<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghi Chú & Chia Sẻ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <!-- Thêm thư viện Crypto-JS để mã hóa MD5 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; } 
        
        /* --- MARKDOWN STYLES --- */
        .markdown-content h1 { font-size: 1.8em; font-weight: bold; margin-top: 0.8em; color: #1e1b4b; line-height: 1.3; scroll-margin-top: 80px; }
        .markdown-content h2 { font-size: 1.5em; font-weight: bold; margin-top: 0.8em; color: #312e81; scroll-margin-top: 80px; }
        .markdown-content h3 { font-size: 1.25em; font-weight: bold; margin-top: 0.8em; color: #4338ca; scroll-margin-top: 80px; }
        .markdown-content ul { list-style-type: disc; padding-left: 1.5em; margin: 0.5em 0; }
        .markdown-content ol { list-style-type: decimal; padding-left: 1.5em; margin: 0.5em 0; }
        .markdown-content blockquote { border-left: 4px solid #6366f1; padding-left: 1em; color: #4b5563; font-style: italic; background: #f9fafb; padding: 0.5rem 1rem; border-radius: 0 0.5rem 0.5rem 0; }
        
        /* CODE BLOCK STYLE - LIGHT THEME & CONSOLAS */
        .markdown-content pre { 
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #1e293b;
            padding: 2.5rem 1rem 1rem 1rem;
            border-radius: 0.5rem; 
            overflow-x: auto; 
            margin: 1em 0; 
            position: relative;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        .markdown-content code { 
            background-color: rgba(0,0,0,0.05);
            color: #d63384; 
            padding: 0.1em 0.3em; 
            border-radius: 0.2em; 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
        }
        .markdown-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            font-size: 0.9em;
        }

        .markdown-content a { color: #4f46e5; text-decoration: underline; }
        .markdown-content img { max-width: 100%; border-radius: 0.5rem; margin-top: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .markdown-content p { margin-bottom: 0.8em; line-height: 1.6; }

        /* --- UI UTILITIES --- */
        .content-collapsed {
            max-height: 120px;
            overflow: hidden;
            position: relative;
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
        }

        /* Nút Copy Code */
        .copy-code-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #e0e7ff;
            color: #4338ca;
            border: 1px solid #c7d2fe;
            border-radius: 0.25rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            opacity: 1;
            transition: all 0.2s;
            z-index: 10;
        }
        .copy-code-btn:hover {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        /* Nút Back to Top */
        #backToTop {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: #4f46e5;
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 40;
        }
        #backToTop.show {
            opacity: 1;
            visibility: visible;
        }

        /* Hiệu ứng trang giấy A4 */
        .a4-paper {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- LOADING & LOGIN OVERLAY -->
    <div id="globalLoading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div id="spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        
        <!-- Login Form (Ẩn mặc định) -->
        <div id="loginForm" class="hidden bg-white p-8 rounded-xl shadow-lg border border-gray-100 max-w-sm w-full mx-4 text-center">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Truy cập Editor</h2>
            <p class="text-sm text-gray-500 mb-6">Nhập mật khẩu để tiếp tục.</p>
            <input type="password" id="passwordInput" placeholder="Nhập mật khẩu..." 
                class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            
            <div class="flex items-center justify-center mb-4">
                 <input id="rememberMe" type="checkbox" checked class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                 <label for="rememberMe" class="ml-2 block text-sm text-gray-900">Ghi nhớ đăng nhập</label>
            </div>

            <button id="loginBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-medium transition">
                Đăng nhập
            </button>
            <p id="loginError" class="text-red-500 text-sm mt-3 hidden">Mật khẩu không đúng!</p>
        </div>
    </div>

    <!-- BACK TO TOP -->
    <button id="backToTop" title="Trở về đầu trang">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <!-- ===== GIAO DIỆN 1: EDITOR (Dành cho người tạo - CẦN MẬT KHẨU) ===== -->
    <div id="creatorView" class="w-full max-w-[297mm] mx-auto p-4 hidden"> 
        
        <!-- Tìm kiếm (Đã nâng cấp giao diện & thêm Datalist) -->
        <div class="max-w-[210mm] mx-auto relative mb-8"> 
            <div class="relative group">
                <!-- Hiệu ứng Glow nền sau -->
                <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-300 to-purple-300 rounded-full opacity-50 group-hover:opacity-100 transition duration-200 blur-sm"></div>
                
                <!-- Input chính -->
                <div class="relative flex items-center bg-white rounded-full shadow-sm">
                    <svg class="w-5 h-5 text-gray-500 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" id="searchInput" list="searchSuggestions"
                        class="w-full p-3.5 pl-3 rounded-full focus:outline-none text-gray-700 bg-transparent placeholder-gray-400 font-medium"
                        placeholder="Gõ từ khóa để tìm (ví dụ: 'Idea', 'Code', 'Dự án')...">
                </div>
            </div>
            <!-- Danh sách gợi ý tự động -->
            <datalist id="searchSuggestions"></datalist>
        </div>

        <!-- EDITOR CONTAINER -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden mb-10 a4-paper">
            
            <!-- Mobile Tabs -->
            <div class="flex border-b border-gray-200 md:hidden">
                <button id="tabWrite" class="flex-1 py-3 text-sm font-semibold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50 transition">
                    Viết nội dung
                </button>
                <button id="tabPreview" class="flex-1 py-3 text-sm font-semibold text-gray-500 hover:text-indigo-600 transition">
                    Xem trước (Review)
                </button>
            </div>

            <!-- Toolbar / Header Desktop -->
            <div class="hidden md:flex justify-between items-center px-4 py-2 bg-gray-50 border-b border-gray-200">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Markdown Input</span>
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Live Preview</span>
            </div>

            <!-- Split Layout -->
            <div class="flex flex-col md:flex-row h-[600px]"> 
                
                <!-- Cột Trái: Input -->
                <div id="editorPane" class="w-full md:w-1/2 h-full flex flex-col border-b md:border-b-0 md:border-r border-gray-200">
                    <textarea id="noteInput" 
                        class="flex-1 w-full p-6 focus:outline-none resize-none font-mono text-sm leading-relaxed text-gray-800"
                        placeholder="# Tiêu đề bài viết...&#10;&#10;Viết nội dung Markdown tại đây...&#10;- Hỗ trợ danh sách&#10;- **In đậm**&#10;- `Code block`"></textarea>
                </div>

                <!-- Cột Phải: Preview -->
                <div id="previewPane" class="w-full md:w-1/2 h-full hidden md:block overflow-y-auto bg-white">
                    <div id="livePreviewContent" class="markdown-content p-6 text-sm">
                        <p class="text-gray-400 italic text-center mt-10">Bản xem trước sẽ hiện tại đây...</p>
                    </div>
                </div>

            </div>

            <!-- Footer Actions -->
            <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                <button id="logoutBtn" class="text-xs text-red-500 hover:underline">Đăng xuất</button>
                <button id="addBtn" 
                    class="ml-auto bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition font-medium shadow hover:shadow-lg transform active:scale-95 duration-200 text-sm">
                    Đăng bài viết
                </button>
            </div>
        </div>

        <!-- Danh sách bài viết -->
        <div class="max-w-[210mm] mx-auto"> 
            <h3 class="text-lg font-bold text-gray-700 mb-4 border-l-4 border-indigo-500 pl-3">Bài viết gần đây</h3>
            <div id="notesList" class="space-y-6"></div>
            
            <div class="mt-8 text-center">
                <button id="loadMoreBtn" class="hidden text-gray-500 hover:text-indigo-600 font-medium text-sm border border-gray-300 rounded-full px-4 py-2 hover:border-indigo-600 transition">
                    Xem các bài cũ hơn ↓
                </button>
            </div>
        </div>
    </div>

    <!-- ===== GIAO DIỆN 2: READER (Dành cho người xem qua Link) ===== -->
    <div id="readerView" class="w-full max-w-[210mm] mx-auto py-8 px-4 hidden">
        <div class="mb-6">
            <!-- Hiệu ứng trang giấy A4 -->
            <article class="bg-white p-8 md:p-10 rounded shadow-md border border-gray-200 min-h-[297mm]">
                <div id="readerContent" class="markdown-content text-gray-800"></div>
                <div class="mt-12 pt-6 border-t border-gray-100 text-center">
                    <p class="text-sm text-gray-400" id="readerDate"></p>
                    <p class="text-xs text-gray-300 mt-1 italic">Shared via My Markdown Notes</p>
                </div>
            </article>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        // THÊM updateDoc VÀ doc
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, limit, getDoc, updateDoc } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCgDNxK4iWLIH4RdcRsayxsM31w2Lc-z8Y",
            authDomain: "nino-8f735.firebaseapp.com",
            projectId: "nino-8f735",
            storageBucket: "nino-8f735.firebasestorage.app",
            messagingSenderId: "383782390686",
            appId: "1:383782390686:web:9b35ddb9ad27cbb540248f"
        };

        // --- CẤU HÌNH MẬT KHẨU (MD5) ---
        // Mã MD5 của "1234". Để đổi pass: Vào trang https://www.md5hashgenerator.com/, nhập pass mới -> copy mã hash dán vào đây.
        const ACCESS_PASSWORD_HASH = "81dc9bdb52d04dc20036dbd8313ed055"; 
        // -------------------------

        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (error) { console.error(error); }

        // --- BIẾN TOÀN CỤC ---
        let editingNoteId = null; // Biến theo dõi ID của ghi chú đang được chỉnh sửa

        // UI Elements
        const globalLoading = document.getElementById('globalLoading');
        const spinner = document.getElementById('spinner');
        const loginForm = document.getElementById('loginForm');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const rememberMe = document.getElementById('rememberMe'); 

        const creatorView = document.getElementById('creatorView');
        const readerView = document.getElementById('readerView');
        const backToTopBtn = document.getElementById('backToTop');
        
        // Editor Elements
        const noteInput = document.getElementById('noteInput');
        const livePreviewContent = document.getElementById('livePreviewContent');
        const editorPane = document.getElementById('editorPane');
        const previewPane = document.getElementById('previewPane');
        const tabWrite = document.getElementById('tabWrite');
        const tabPreview = document.getElementById('tabPreview');
        
        const notesList = document.getElementById('notesList');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const searchInput = document.getElementById('searchInput');

        const COLLECTION_NAME = "daily_notes";
        const DRAFT_KEY = 'my_markdown_draft';
        const SESSION_KEY = 'my_markdown_auth_token'; 
        
        let currentLimit = 10;
        let unsubscribe = null;
        let allNotesData = [];

        marked.use({ breaks: true, gfm: true });

        // --- HÀM 1: CẬP NHẬT GỢI Ý TÌM KIẾM ---
        function updateSearchSuggestions(notes) {
            const datalist = document.getElementById('searchSuggestions');
            if (!datalist) return;
            
            datalist.innerHTML = '';
            
            notes.slice(0, 20).forEach(note => {
                if (!note.content) return;
                
                let suggestion = note.content.split('\n')[0].replace(/[#*`]/g, '').trim();
                
                if (suggestion) {
                    const option = document.createElement('option');
                    option.value = suggestion;
                    datalist.appendChild(option);
                }
            });
        }

        // --- HÀM 2: KHÔI PHỤC BẢN NHÁP ---
        function loadDraft() {
            const savedDraft = localStorage.getItem(DRAFT_KEY);
            if (savedDraft) {
                noteInput.value = savedDraft;
                const cleanHtml = DOMPurify.sanitize(marked.parse(savedDraft));
                livePreviewContent.innerHTML = cleanHtml;
                enhanceContent(livePreviewContent);
            }
        }
        
        // --- HÀM 3: ĐẶT LẠI TRẠNG THÁI EDITOR ---
        function resetEditor() {
            editingNoteId = null;
            noteInput.value = '';
            
            // Đặt lại nút Đăng bài
            addBtn.textContent = "Đăng bài viết";
            addBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            addBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');

            // Xóa nháp
            localStorage.removeItem(DRAFT_KEY);
            
            // Xóa preview
            livePreviewContent.innerHTML = '<p class="text-gray-400 italic text-center mt-10">Bản xem trước sẽ hiện tại đây...</p>';
            
            // Đặt lại tìm kiếm
            searchInput.value = '';
            filterAndRender('');
        }
        
        // --- HÀM 4: VÀO CHẾ ĐỘ CHỈNH SỬA (Gọi từ onclick) ---
        window.enterEditMode = (id) => {
            const noteToEdit = allNotesData.find(note => note.id === id);
            if (!noteToEdit) return;
            
            // 1. Lưu ID và đổ dữ liệu
            editingNoteId = id;
            noteInput.value = noteToEdit.content;
            
            // 2. Thay đổi nút thành CẬP NHẬT
            addBtn.textContent = "Cập nhật ghi chú";
            addBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            addBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            
            // 3. Tự động cuộn lên đầu và kích hoạt preview/auto save
            creatorView.scrollIntoView({ behavior: 'smooth', block: 'start' });
            noteInput.dispatchEvent(new Event('input')); // Kích hoạt auto-save và preview
        }
        
        // --- XỬ LÝ ĐĂNG NHẬP / BẢO MẬT ---
        function checkAccess() {
            const storedHash = localStorage.getItem(SESSION_KEY) || sessionStorage.getItem(SESSION_KEY);
            
            if (storedHash === ACCESS_PASSWORD_HASH) {
                showCreatorView();
            } else {
                spinner.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        }

        loginBtn.addEventListener('click', () => {
            const input = passwordInput.value;
            const inputHash = CryptoJS.MD5(input).toString();

            if (inputHash === ACCESS_PASSWORD_HASH) {
                if (rememberMe.checked) {
                    localStorage.setItem(SESSION_KEY, inputHash);
                } else {
                    sessionStorage.setItem(SESSION_KEY, inputHash);
                }
                
                showCreatorView();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        passwordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem(SESSION_KEY);
            sessionStorage.removeItem(SESSION_KEY);
            window.location.reload();
        });

        function showCreatorView() {
            globalLoading.classList.add('hidden');
            creatorView.classList.remove('hidden');
            loadNotes(currentLimit);
            loadDraft();
        }

        // --- MOBILE TABS LOGIC ---
        function switchTab(mode) {
            if (mode === 'write') {
                tabWrite.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600', 'bg-indigo-50');
                tabWrite.classList.remove('text-gray-500');
                tabPreview.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600', 'bg-indigo-50');
                tabPreview.classList.add('text-gray-500');
                editorPane.classList.remove('hidden');
                previewPane.classList.add('hidden');
                previewPane.classList.remove('md:block');
                previewPane.classList.add('md:block');
            } else {
                tabPreview.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600', 'bg-indigo-50');
                tabPreview.classList.remove('text-gray-500');
                tabWrite.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600', 'bg-indigo-50');
                tabWrite.classList.add('text-gray-500');
                editorPane.classList.add('hidden');
                previewPane.classList.remove('hidden');
            }
        }

        tabWrite.addEventListener('click', () => switchTab('write'));
        tabPreview.addEventListener('click', () => switchTab('preview'));

        // --- REAL-TIME PREVIEW & AUTO SAVE ---
        noteInput.addEventListener('input', () => {
            const val = noteInput.value;
            localStorage.setItem(DRAFT_KEY, val);
            if (!val.trim()) {
                livePreviewContent.innerHTML = '<p class="text-gray-400 italic text-center mt-10">Bản xem trước sẽ hiện tại đây...</p>';
                return;
            }
            const cleanHtml = DOMPurify.sanitize(marked.parse(val));
            livePreviewContent.innerHTML = cleanHtml;
            enhanceContent(livePreviewContent);
        });

        // --- BACK TO TOP ---
        window.onscroll = function() {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                backToTopBtn.classList.add("show");
            } else {
                backToTopBtn.classList.remove("show");
            }
        };

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // --- CONTENT ENHANCEMENT ---
        function enhanceContent(containerElement) {
            const headings = containerElement.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headings.forEach(heading => {
                const text = heading.textContent;
                const slug = text.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/[đĐ]/g, "d")
                    .replace(/[^a-z0-9\s-]/g, '')
                    .trim()
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');

                if (slug) {
                    heading.id = slug;
                    heading.style.position = 'relative';
                    heading.style.cursor = 'pointer';
                    heading.title = "Click để copy link tới mục này";
                    heading.onclick = () => {
                        const url = window.location.href.split('#')[0] + '#' + slug;
                        navigator.clipboard.writeText(url).then(() => {
                            const originalColor = heading.style.color;
                            heading.style.color = '#4f46e5';
                            setTimeout(() => heading.style.color = originalColor, 500);
                        });
                    };
                }
            });

            const preBlocks = containerElement.querySelectorAll('pre');
            preBlocks.forEach(pre => {
                if (pre.querySelector('.copy-code-btn')) return;

                const btn = document.createElement('button');
                btn.className = 'copy-code-btn';
                btn.textContent = 'Copy';
                
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const code = pre.querySelector('code').innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        btn.textContent = 'Copied!';
                        btn.style.backgroundColor = '#4f46e5';
                        btn.style.color = '#fff';
                        setTimeout(() => {
                            btn.textContent = 'Copy';
                            btn.style.backgroundColor = '';
                            btn.style.color = '';
                        }, 2000);
                    });
                });
                
                pre.appendChild(btn);
            });
        }

        // --- APP INIT ---
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedId = urlParams.get('id');

            if (sharedId) {
                await loadSingleNote(sharedId);
            } else {
                checkAccess();
            }
        }

        async function loadSingleNote(id) {
            try {
                const docRef = doc(db, COLLECTION_NAME, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const cleanHtml = DOMPurify.sanitize(marked.parse(data.content || ""));
                    
                    const contentContainer = document.getElementById('readerContent');
                    contentContainer.innerHTML = cleanHtml;
                    enhanceContent(contentContainer);
                    
                    if (data.createdAt) {
                        const date = new Date(data.createdAt.seconds * 1000);
                        document.getElementById('readerDate').textContent = "Đăng lúc: " + date.toLocaleString('vi-VN');
                    }
                    
                    globalLoading.classList.add('hidden');
                    readerView.classList.remove('hidden');
                } else {
                    alert("Bài viết không tồn tại!");
                    window.location.href = "index.html"; 
                }
            } catch (error) {
                console.error("Lỗi:", error);
            }
        }

        function loadNotes(limitCount) {
            if (!db) return;
            loadMoreBtn.classList.add('hidden');
            if (unsubscribe) unsubscribe();

            const q = query(
                collection(db, COLLECTION_NAME), 
                orderBy("createdAt", "desc"), 
                limit(limitCount)
            );

            unsubscribe = onSnapshot(q, (snapshot) => {
                notesList.innerHTML = '';
                allNotesData = [];

                if (snapshot.empty) {
                    notesList.innerHTML = '<div class="text-center py-10 bg-white rounded-xl border border-dashed border-gray-300"><p class="text-gray-400">Chưa có bài viết nào.</p></div>';
                    return;
                }

                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    data.id = docSnapshot.id;
                    allNotesData.push(data);
                });
                
                updateSearchSuggestions(allNotesData);

                filterAndRender(searchInput.value);

                if (snapshot.size >= limitCount) {
                    loadMoreBtn.classList.remove('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
            });
        }

        function filterAndRender(keyword) {
            const searchTerm = keyword.toLowerCase().trim();
            notesList.innerHTML = '';

            const filteredNotes = allNotesData.filter(note => {
                return !searchTerm || (note.content && note.content.toLowerCase().includes(searchTerm));
            });

            filteredNotes.forEach(note => {
                const id = note.id;
                let timeString = note.createdAt ? new Date(note.createdAt.seconds * 1000).toLocaleString('vi-VN') : "...";
                const cleanHtml = DOMPurify.sanitize(marked.parse(note.content || ""));

                const isLong = (note.content && note.content.length > 300) || (note.content && note.content.split('\n').length > 5);
                const collapseClass = isLong ? 'content-collapsed' : '';
                const btnDisplay = isLong ? 'block' : 'hidden';

                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition duration-300 a4-paper"; 
                div.innerHTML = `
                    <div id="content-${id}" class="markdown-content text-gray-800 break-words transition-all duration-300 ${collapseClass}">
                        ${cleanHtml}
                    </div>
                    
                    <button onclick="toggleNote('${id}')" id="btn-${id}" class="${btnDisplay} text-indigo-600 text-sm font-semibold mt-3 hover:bg-indigo-50 px-3 py-1 rounded transition focus:outline-none">
                        Xem tiếp ↓
                    </button>

                    <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-50">
                        <span class="text-xs text-gray-400">${timeString}</span>
                        <div class="flex gap-2">
                            <!-- Nút SỬA (Mới) -->
                            <button onclick="enterEditMode('${id}')" class="flex items-center gap-1 text-gray-500 hover:text-green-600 hover:bg-green-50 px-3 py-1.5 rounded-lg transition text-sm font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                Sửa
                            </button>
                            
                            <!-- Nút Chia sẻ -->
                            <button onclick="shareNote('${id}')" class="flex items-center gap-1 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 px-3 py-1.5 rounded-lg transition text-sm font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                                Chia sẻ
                            </button>
                            
                            <!-- Nút Xóa -->
                            <button class="delete-btn text-gray-400 hover:text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg transition text-sm font-medium" data-id="${id}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                
                div.querySelector('.delete-btn').addEventListener('click', () => deleteNote(id));
                enhanceContent(div.querySelector('.markdown-content'));
                notesList.appendChild(div);
            });
        }

        searchInput.addEventListener('input', (e) => filterAndRender(e.target.value));

        document.getElementById('addBtn').addEventListener('click', async () => {
            const content = noteInput.value.trim();
            if (!content) return;
            const btn = document.getElementById('addBtn');
            
            btn.textContent = editingNoteId ? "Đang cập nhật..." : "Đang đăng...";
            btn.disabled = true;

            try {
                if (editingNoteId) {
                    // CHỨC NĂNG CẬP NHẬT (UPDATE)
                    const docRef = doc(db, COLLECTION_NAME, editingNoteId);
                    await updateDoc(docRef, {
                        content: content,
                        updatedAt: serverTimestamp() // Thêm thời gian cập nhật
                    });
                    alert("Đã cập nhật ghi chú thành công!");
                } else {
                    // CHỨC NĂNG THÊM MỚI (ADD)
                    await addDoc(collection(db, COLLECTION_NAME), {
                        content: content,
                        createdAt: serverTimestamp()
                    });
                }
                
                resetEditor(); // Reset UI sau khi thành công

                // Load lại danh sách
                currentLimit = 10;
                loadNotes(currentLimit);

                if(window.innerWidth < 768) switchTab('write'); 
            } catch (error) { 
                console.error("Lỗi:", error);
                alert("Lỗi khi lưu/cập nhật: " + error.message); 
            }
            finally {
                btn.textContent = editingNoteId ? "Cập nhật ghi chú" : "Đăng bài viết";
                btn.disabled = false;
            }
        });

        loadMoreBtn.addEventListener('click', () => {
            currentLimit += 10;
            loadNotes(currentLimit);
        });

        async function deleteNote(id) {
            if (confirm('Bạn muốn xóa bài viết này?')) {
                try { await deleteDoc(doc(db, COLLECTION_NAME, id)); } 
                catch (e) { alert("Lỗi xóa"); }
            }
        }

        window.toggleNote = (id) => {
            const content = document.getElementById(`content-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            if (content.classList.contains('content-collapsed')) {
                content.classList.remove('content-collapsed');
                btn.textContent = "Thu gọn ↑";
            } else {
                content.classList.add('content-collapsed');
                btn.textContent = "Xem tiếp ↓";
                content.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        };

        window.shareNote = (id) => {
            const baseUrl = window.location.href.split('?')[0];
            const shareUrl = `${baseUrl}?id=${id}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("Đã copy link bài viết!");
            }).catch(err => {
                prompt("Copy link:", shareUrl);
            });
        };

        init();
    </script>
</body>
</html>
